# 病历本 App 功能设计（初稿）

## 1. 产品概述
- 面向个人与家庭的病历管理 App，聚焦“就诊记录、处方文档、慢病复查提醒”。
- 通过文档扫描（拍照裁边、图像增强、合成 PDF）保存纸质病历与处方。
- 记录就诊信息（日期、医院、科室、医生、项目），并关联扫描文档与处方。
- 建立慢病档案，配置复查计划与提醒，降低漏检与忘记随访的风险。

## 2. 目标用户与核心场景
- 目标用户：有慢病管理需求（如高血压、糖尿病、甲状腺疾病等）或家庭多成员病历归档需求的普通用户。
- 核心场景：
  1) 就诊后拍照扫描处方/检验单/出院小结，自动裁边增强并保存为 PDF/图片。
  2) 创建就诊记录，填写医院、日期、项目、医生，关联扫描文件与处方用药。
  3) 为慢病设置复查计划（如“每3个月复查血糖+肾功”），到期前推送提醒。
  4) 快速搜索过往记录，按日期、医院、疾病、标签筛选，或在日历视图查看。
  5) 一键导出备份（含数据库与文件），可分享或迁移设备。

## 3. 功能清单（MVP）
- 文档扫描
  - CameraX 拍照、单/多页扫描、手动裁边、灰度/增强、重拍与排序
  - 导出为 PDF 或保留原图，支持重命名、标签、备注
- 就诊记录
  - 字段：就诊日期、医院、科室、医生、就诊项目（可多选/自由输入）、费用（可选）
  - 附件：关联扫描文档、处方、检验单等
- 处方与用药
  - 药品条目：名称、规格、剂量、频次、疗程、备注
  - 可选用药提醒（MVP先记录，不做周期提醒；提醒由“复查”统一提供）
- 慢病管理与复查提醒
  - 疾病档案：疾病名称、确诊日期、主治科室、备注
  - 复查计划：检查项目清单、周期（如每1/3/6/12个月）、首次起始日期、提醒提前量
  - 提醒：WorkManager + 通知（支持 Android 13+ 通知权限处理）
- 搜索与筛选
  - 按关键词（医院/医生/项目/疾病/标签）、日期范围；支持日历视图
- 本地备份与导出
  - 导出 ZIP：数据库（JSON/Room导出）+ 文件（图片/PDF），可选加密
- 基础设置
  - 数据与备份位置、默认导出格式、主题（跟随系统/浅色/深色）、隐私设置

非MVP（后续版本）：OCR 识别文本、云备份（Drive/OneDrive/WebDAV）、家庭成员多账号、共享。

## 4. 技术栈与平台
- 语言与UI：Kotlin + Jetpack Compose + Material 3 + Navigation
- 依赖注入：Hilt
- 本地存储：Room（数据库） + DataStore（偏好）
- 后台与提醒：WorkManager + Notification
- 相机与扫描：CameraX；裁边/增强：自研或轻量图像处理（后续可接入 OpenCV/ML Kit）
- PDF 生成：PdfDocument 或第三方轻量库
- 图片处理：Bitmap/RenderScript 替代（GPU/RenderEffect，按 API 调整），基础增强（灰度/对比度）
- 最低/目标 SDK：minSdk 24~26（建议26），targetSdk 34/35

待确认：是否内置 OCR；是否引入 SQLCipher 或 Jetpack Security Crypto 做本地加密。

## 5. 架构与模块
- 架构：Clean Architecture + MVVM
  - presentation（Compose UI, ViewModel）
  - domain（use cases, models）
  - data（repositories, Room DAOs, local sources）
- 建议多模块（后续可拆分）：
  - app（组合壳与导航）
  - core:ui（主题、组件）
  - core:data（存储、网络占位）
  - feature:record（就诊记录与时间线）
  - feature:scan（扫描与PDF）
  - feature:chronic（慢病与复查）
  - feature:backup（导出/导入）

## 6. 数据模型（Room 草案）
- Visit（就诊）
  - id, date, hospital, department, doctor, items[text], cost[float?], note
- Document（文档）
  - id, title, type[scan/prescription/report], createdAt, pages[int], path, thumbPath, visitId(FK), tags
- Prescription（处方）
  - id, visitId(FK), title, note
- DrugItem（药品）
  - id, prescriptionId(FK), name, spec, dose, frequency, duration, note
- ChronicCondition（慢病）
  - id, name, diagnosedAt, department, note
- CheckupPlan（复查计划）
  - id, conditionId(FK), items[text], intervalMonths[int], startDate, remindDaysBefore[int]
- Reminder（提醒实例，派生生成，可选）
  - id, planId(FK), dueDate, status[pending/done], firedAt

索引：Visit.date、Document.visitId、DrugItem.prescriptionId、CheckupPlan.conditionId。

## 7. 关键用户流
- 扫描流程：
  1) 打开扫描 → 取景拍照 → 自动/手动裁边 → 图像增强 → 预览排序 → 保存为PDF或图片
  2) 命名与标签 → 选择关联“就诊记录”或稍后关联
- 新建就诊：
  1) 选择日期/医院/科室/医生/项目 → 关联扫描文档与处方 → 保存
- 创建慢病与复查：
  1) 新建疾病档案 → 配置复查计划（项目、周期、起始、提醒提前量）→ 系统生成提醒 → 到期通知

## 8. 权限与合规
- CAMERA：拍照扫描
- POST_NOTIFICATIONS：Android 13+ 运行时权限
- 读写媒体：优先应用私有存储与SAF分享，避免广泛读写权限
- 隐私：默认离线，不采集个人数据；导出/分享前向用户解释内容范围

## 9. 存储与备份
- 文件：保存在应用私有目录（scoped storage），按yyyy/MM/分层；文件名含时间戳与标题
- 数据库：Room，定期备份（手动）
- 导出：ZIP（/export/），内含：metadata.json（版本、导出时间）、db.json（序列化数据）、files/（PDF与图片）
- 可选加密：用户输入密码 → AES-GCM → 保存.enc

## 10. UI/UX 纲要
- 主题：Material 3 + 动态色；深浅色；大字号/无障碍适配
- 主要页面：
  - 首页：时间线（最近就诊/文档），快速入口（扫描/新建就诊/新建慢病）
  - 搜索/筛选：顶部搜索，支持标签/日期/类型过滤
  - 扫描：取景预览、拍摄、裁边、增强、预览排序、保存
  - 就诊详情：基础信息 + 附件 + 处方
  - 慢病与复查：档案列表、复查计划、提醒列表、日历视图
  - 设置：备份导出、主题、隐私

## 11. 日历与提醒
- 日历：按月展示就诊与复查事件；点击进入详情
- 提醒：按计划生成任务，提前N天通知；可标记完成或延期

## 12. 开发计划（里程碑）
- M1（MVP）：
  - 工程脚手架、数据模型与Room、扫描基础（拍照/裁边/PDF）、就诊CRUD、复查提醒
- M2：
  - 搜索/筛选/日历、导出备份、基础设置、测试与稳定性
- M3：
  - OCR、云备份、家庭成员、更多增强

## 13. 风险与替代方案
- 裁边与增强算法难度：先提供半自动+手动；后续接入OpenCV/ML Kit
- 本地加密：首版先不加密，文档导出提供密码加密；后续评估 SQLCipher/Jetpack Security
- 机型兼容：CameraX + 严格权限与文件策略；大量设备测试

## 14. 命名与配置（待确认）
- 应用名（中文/英文）：例如「病历本」/ "Med Ledger"（可提议）
- 包名：例如 `com.lessup.medledger` 或你指定的组织域名
- 最低/目标SDK：建议 minSdk 26, targetSdk 35
- 是否启用 OCR（首版建议不启用）
- 是否启用本地加密（首版建议仅导出加密）

## 15. 成功标准
- 10分钟内完成一次从扫描到创建就诊并设定复查的全流程
- App首屏操作路径不超过3步即可完成扫描或新建就诊
- 重要信息可在3次点击内找到；提醒到达率>98%
