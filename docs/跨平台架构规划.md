# 病历本 - 跨平台架构规划

## 一、当前架构分析

### 1.1 现有技术栈
| 层级 | 技术 |
|------|------|
| UI | Jetpack Compose + Material 3 |
| DI | Hilt |
| 架构 | MVVM (ViewModel + StateFlow) |
| 本地存储 | Room (SQLite) |
| 后台任务 | WorkManager |
| 相机 | CameraX |

### 1.2 数据模型
- **Visit** - 就诊记录
- **Document** - 文档/扫描件
- **Prescription** - 处方
- **DrugItem** - 药品
- **ChronicCondition** - 慢病档案
- **CheckupPlan** - 复查计划

### 1.3 扩展瓶颈
- ❌ 纯 Android 原生，无法复用
- ❌ 无网络层和用户认证
- ❌ 无云端同步能力
- ❌ 文件仅本地存储

---

## 二、跨平台架构方案

### 2.1 推荐方案：Kotlin Multiplatform (KMP)

```
                    ┌─────────────────────┐
                    │   Cloud Services    │
                    │  API + OSS + Auth   │
                    └─────────┬───────────┘
                              │
            ┌─────────────────┴─────────────────┐
            │     Shared Module (KMP)           │
            │  Models + Repository + Network    │
            └─────────────────┬─────────────────┘
                              │
    ┌─────────────┬───────────┴───────────┬─────────────┐
    │   Android   │         iOS           │   WeChat    │
    │  (Compose)  │    (SwiftUI/KMP)      │ MiniProgram │
    └─────────────┴───────────────────────┴─────────────┘
```

### 2.2 技术选型
| 方案 | 推荐度 | 理由 |
|------|--------|------|
| **KMP** | ⭐⭐⭐⭐⭐ | 复用现有 Kotlin 代码 |
| Flutter | ⭐⭐⭐ | 需重写，包体积大 |
| React Native | ⭐⭐ | 性能一般 |

---

## 三、账号同步系统

### 3.1 用户认证
```kotlin
sealed class AuthMethod {
    data class Phone(val number: String, val code: String) : AuthMethod()
    data class WeChat(val openId: String) : AuthMethod()
    data class Apple(val token: String) : AuthMethod()
}
```

### 3.2 同步实体扩展
```kotlin
interface Syncable {
    val localId: Long
    val remoteId: String?
    val userId: String?
    val updatedAt: Long
    val syncStatus: SyncStatus  // SYNCED, PENDING, CONFLICT
    val version: Long
}
```

### 3.3 同步流程
1. **Pull** - 从服务端拉取变更
2. **Merge** - 本地合并，解决冲突
3. **Push** - 推送本地变更
4. **Confirm** - 更新同步状态

### 3.4 冲突解决
- **LastWriteWins** - 最后修改优先（默认）
- **ServerWins** - 服务端优先
- **Manual** - 手动合并

---

## 四、后端服务设计

### 4.1 技术选型
| 组件 | 方案 |
|------|------|
| 语言 | Kotlin (Ktor) / Go |
| 数据库 | PostgreSQL |
| 对象存储 | 阿里云 OSS |
| 认证 | JWT + OAuth2 |

### 4.2 核心 API
```
POST /api/v1/auth/login      # 登录
GET  /api/v1/sync?since=ts   # 拉取变更
POST /api/v1/sync            # 推送变更
POST /api/v1/oss/presign     # 获取上传URL
```

---

## 五、iOS 平台

### 5.1 共享代码结构
```
shared/
├── commonMain/
│   ├── data/model/      # 数据模型
│   ├── data/repository/ # Repository
│   ├── network/         # Ktor Client
│   └── sync/            # 同步引擎
├── androidMain/         # Android 特定
└── iosMain/             # iOS 特定
```

### 5.2 iOS 界面
- SwiftUI 原生开发
- 调用 KMP 共享业务逻辑
- 原生相机/通知能力

---

## 六、微信小程序

### 6.1 技术方案
- 框架：原生 / Taro
- UI：WeUI / Vant
- 存储：云端优先（本地有限）

### 6.2 功能适配
| 功能 | 小程序实现 |
|------|-----------|
| 扫描 | wx.chooseImage + 服务端 OCR |
| 通知 | 订阅消息 |
| 存储 | 云存储 |

---

## 七、功能扩展规划

### 7.1 新增功能
| 功能 | 优先级 |
|------|--------|
| 家庭成员管理 | P0 |
| 费用统计分析 | P1 |
| 智能复诊提醒 | P1 |
| OCR 识别 | P2 |
| 健康档案 | P2 |

### 7.2 UI/UX 优化
- Skeleton 骨架屏加载
- 下拉刷新 + 触底加载
- 滑动删除 + Undo
- 共享元素过渡动画
- 统一设计系统

---

## 八、实施路线图

| 阶段 | 内容 | 周期 |
|------|------|------|
| Phase 1 | 后端 API + 认证 | 4-6周 |
| Phase 2 | 数据同步引擎 | 4周 |
| Phase 3 | iOS 平台开发 | 6-8周 |
| Phase 4 | 微信小程序 | 4-6周 |
| Phase 5 | 功能增强 | 持续 |

---

## 九、技术债务

### 需要重构
1. Room -> SQLDelight（支持 KMP）
2. Hilt -> Koin（支持 KMP）
3. 添加 Ktor 网络层
4. 实体扩展同步字段

### 风险评估
| 风险 | 缓解措施 |
|------|----------|
| KMP 生态 | 关注社区，准备备选 |
| 同步冲突 | 完善冲突解决机制 |
| 数据合规 | 加密存储，用户授权 |
