# 技术实施指南

## 一、项目重构步骤

### Step 1: 添加 KMP 支持

```kotlin
// settings.gradle.kts
pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}

// 新增 shared 模块
include(":shared")
include(":app")
```

### Step 2: 共享模块配置

```kotlin
// shared/build.gradle.kts
plugins {
    kotlin("multiplatform")
    kotlin("plugin.serialization")
    id("com.android.library")
    id("app.cash.sqldelight")
}

kotlin {
    androidTarget()
    iosX64()
    iosArm64()
    iosSimulatorArm64()
    
    sourceSets {
        commonMain.dependencies {
            implementation("io.ktor:ktor-client-core:2.3.7")
            implementation("io.ktor:ktor-client-content-negotiation:2.3.7")
            implementation("io.ktor:ktor-serialization-kotlinx-json:2.3.7")
            implementation("app.cash.sqldelight:runtime:2.0.1")
            implementation("org.jetbrains.kotlinx:kotlinx-coroutines-core:1.8.0")
            implementation("io.insert-koin:koin-core:3.5.3")
        }
        androidMain.dependencies {
            implementation("io.ktor:ktor-client-okhttp:2.3.7")
            implementation("app.cash.sqldelight:android-driver:2.0.1")
        }
        iosMain.dependencies {
            implementation("io.ktor:ktor-client-darwin:2.3.7")
            implementation("app.cash.sqldelight:native-driver:2.0.1")
        }
    }
}
```

---

## 二、数据模型迁移

### SQLDelight Schema
```sql
-- shared/src/commonMain/sqldelight/com/lessup/medledger/Visit.sq

CREATE TABLE Visit (
    localId INTEGER PRIMARY KEY AUTOINCREMENT,
    remoteId TEXT,
    userId TEXT,
    date INTEGER NOT NULL,
    hospital TEXT NOT NULL,
    department TEXT,
    doctor TEXT,
    items TEXT,
    cost REAL,
    note TEXT,
    memberId TEXT,
    createdAt INTEGER NOT NULL,
    updatedAt INTEGER NOT NULL,
    deletedAt INTEGER,
    syncStatus TEXT NOT NULL DEFAULT 'PENDING',
    version INTEGER NOT NULL DEFAULT 1
);

selectAll:
SELECT * FROM Visit WHERE deletedAt IS NULL ORDER BY date DESC;

selectById:
SELECT * FROM Visit WHERE localId = ?;

selectPending:
SELECT * FROM Visit WHERE syncStatus = 'PENDING';

insert:
INSERT INTO Visit(remoteId, userId, date, hospital, department, doctor, 
    items, cost, note, memberId, createdAt, updatedAt, syncStatus, version)
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);

updateSyncStatus:
UPDATE Visit SET syncStatus = ?, remoteId = ?, version = ? WHERE localId = ?;
```

---

## 三、网络层实现

### API Client
```kotlin
// shared/src/commonMain/kotlin/network/ApiClient.kt
class ApiClient(
    private val baseUrl: String,
    private val tokenProvider: TokenProvider
) {
    private val client = HttpClient {
        install(ContentNegotiation) { json() }
        install(Auth) {
            bearer {
                loadTokens { tokenProvider.getTokens() }
                refreshTokens { tokenProvider.refresh() }
            }
        }
    }
    
    suspend fun sync(since: Long): SyncResponse {
        return client.get("$baseUrl/api/v1/sync") {
            parameter("since", since)
        }.body()
    }
    
    suspend fun pushChanges(changes: List<SyncChange>): SyncResult {
        return client.post("$baseUrl/api/v1/sync") {
            setBody(SyncRequest(changes))
        }.body()
    }
}
```

---

## 四、同步引擎

```kotlin
// shared/src/commonMain/kotlin/sync/SyncEngine.kt
class SyncEngine(
    private val apiClient: ApiClient,
    private val database: AppDatabase,
    private val preferences: Preferences
) {
    suspend fun sync(): SyncResult {
        val lastSync = preferences.getLong("last_sync", 0)
        
        // 1. Pull
        val remote = apiClient.sync(lastSync)
        
        // 2. Merge
        remote.changes.forEach { change ->
            mergeChange(change)
        }
        
        // 3. Push
        val pending = database.getPendingChanges()
        val result = apiClient.pushChanges(pending)
        
        // 4. Update status
        result.confirmed.forEach { id ->
            database.markSynced(id)
        }
        
        preferences.putLong("last_sync", System.currentTimeMillis())
        return result
    }
    
    private suspend fun mergeChange(remote: SyncChange) {
        val local = database.getByRemoteId(remote.id)
        when {
            local == null -> database.insert(remote.toEntity())
            remote.version > local.version -> database.update(remote.toEntity())
            remote.version < local.version -> { /* keep local, mark conflict */ }
            else -> { /* same version, no action */ }
        }
    }
}
```

---

## 五、后端 API 示例 (Ktor)

```kotlin
// backend/src/main/kotlin/Application.kt
fun Application.module() {
    install(ContentNegotiation) { json() }
    install(Authentication) {
        jwt("auth-jwt") {
            verifier(JwtConfig.verifier)
            validate { credential ->
                UserPrincipal(credential.payload.getClaim("userId").asString())
            }
        }
    }
    
    routing {
        post("/api/v1/auth/login") {
            val request = call.receive<LoginRequest>()
            val user = authService.login(request)
            call.respond(TokenResponse(generateToken(user)))
        }
        
        authenticate("auth-jwt") {
            get("/api/v1/sync") {
                val userId = call.principal<UserPrincipal>()!!.userId
                val since = call.parameters["since"]?.toLong() ?: 0
                val changes = syncService.getChanges(userId, since)
                call.respond(SyncResponse(changes))
            }
            
            post("/api/v1/sync") {
                val userId = call.principal<UserPrincipal>()!!.userId
                val request = call.receive<SyncRequest>()
                val result = syncService.applyChanges(userId, request.changes)
                call.respond(result)
            }
        }
    }
}
```

---

## 六、iOS SwiftUI 示例

```swift
// iOS/MedLedger/Views/VisitListView.swift
import SwiftUI
import shared

struct VisitListView: View {
    @StateObject private var viewModel = VisitListViewModel()
    
    var body: some View {
        NavigationView {
            List(viewModel.visits, id: \.localId) { visit in
                NavigationLink(destination: VisitDetailView(visit: visit)) {
                    VisitRow(visit: visit)
                }
            }
            .navigationTitle("就诊记录")
            .refreshable {
                await viewModel.sync()
            }
        }
    }
}

class VisitListViewModel: ObservableObject {
    private let repository = KoinHelper().visitRepository
    @Published var visits: [Visit] = []
    
    init() {
        loadVisits()
    }
    
    func loadVisits() {
        Task {
            for await list in repository.observeAll() {
                await MainActor.run { visits = list }
            }
        }
    }
    
    func sync() async {
        try? await repository.sync()
    }
}
```

---

## 七、微信小程序示例

```javascript
// miniprogram/pages/visit/list.js
const api = require('../../services/api')

Page({
  data: {
    visits: [],
    loading: false
  },
  
  onLoad() {
    this.loadVisits()
  },
  
  async loadVisits() {
    this.setData({ loading: true })
    try {
      const visits = await api.getVisits()
      this.setData({ visits })
    } finally {
      this.setData({ loading: false })
    }
  },
  
  onPullDownRefresh() {
    this.loadVisits().then(() => {
      wx.stopPullDownRefresh()
    })
  },
  
  goDetail(e) {
    const id = e.currentTarget.dataset.id
    wx.navigateTo({ url: `/pages/visit/detail?id=${id}` })
  }
})
```

```xml
<!-- miniprogram/pages/visit/list.wxml -->
<view class="container">
  <view class="visit-card" wx:for="{{visits}}" wx:key="id" 
        bindtap="goDetail" data-id="{{item.id}}">
    <view class="hospital">{{item.hospital}}</view>
    <view class="info">
      <text>{{item.date}}</text>
      <text wx:if="{{item.department}}">{{item.department}}</text>
    </view>
  </view>
  <view class="empty" wx:if="{{!visits.length && !loading}}">
    暂无就诊记录
  </view>
</view>
```

---

## 八、家庭成员功能

```kotlin
// 家庭成员实体
data class FamilyMember(
    val id: String,
    val userId: String,
    val name: String,
    val relationship: Relationship,
    val birthDate: Long?,
    val avatar: String?,
    val isDefault: Boolean
)

enum class Relationship {
    SELF, SPOUSE, CHILD, PARENT, OTHER
}

// UI 支持成员切换
@Composable
fun MemberSelector(
    members: List<FamilyMember>,
    selected: FamilyMember?,
    onSelect: (FamilyMember) -> Unit
) {
    LazyRow(horizontalArrangement = Arrangement.spacedBy(8.dp)) {
        items(members) { member ->
            FilterChip(
                selected = member == selected,
                onClick = { onSelect(member) },
                label = { Text(member.name) },
                leadingIcon = {
                    AsyncImage(model = member.avatar, ...)
                }
            )
        }
    }
}
```

---

## 九、费用统计功能

```kotlin
@Composable
fun CostAnalyticsScreen(vm: CostAnalyticsViewModel = hiltViewModel()) {
    val summary by vm.summary.collectAsStateWithLifecycle()
    val trend by vm.monthlyTrend.collectAsStateWithLifecycle()
    
    LazyColumn {
        // 总览卡片
        item {
            SummaryCard(
                totalCost = summary.total,
                visitCount = summary.count,
                avgCost = summary.average
            )
        }
        
        // 月度趋势图表
        item {
            LineChart(
                data = trend,
                xAxis = { it.month },
                yAxis = { it.cost }
            )
        }
        
        // 科室分布饼图
        item {
            PieChart(data = summary.byDepartment)
        }
    }
}
```
