# 2025-12-18 同步协议 localId 修复

## 变更概要
- 修复同步协议中 `SyncConfirmation.localId` 服务端固定返回 0 的问题，改为回传客户端推送的 `localId`，用于客户端正确回填 `remoteId` 映射。
- 同步协议 `SyncChange` 增加 `localId` 字段（默认 0 保持兼容）。
- shared 同步引擎合并逻辑由按 `localId` 查找改为按 `remoteId(entityId)` 查找，避免远端数据无法正确匹配本地记录。

## 修改文件
- shared/src/commonMain/kotlin/com/lessup/medledger/network/ApiModels.kt
  - `SyncChange` 增加 `localId: Long = 0`
- shared/src/commonMain/kotlin/com/lessup/medledger/sync/SyncEngine.kt
  - push：构建 `SyncChange` 时携带 `localId`
  - merge：visit 合并按 `remoteId(entityId)` 查找并应用，且使用 `change.version` 作为权威版本号
- shared/src/commonMain/kotlin/com/lessup/medledger/repository/VisitRepository.kt
  - 新增 `getByRemoteId(remoteId: String)`
- backend/src/main/kotlin/com/lessup/medledger/routes/SyncRoutes.kt
  - `SyncChange` 增加 `localId: Long = 0`
- backend/src/main/kotlin/com/lessup/medledger/service/SyncService.kt
  - `SyncConfirmation.localId` 回传 `change.localId`
  - 服务端写入同步日志时使用服务端版本号（`version = change.version + 1`）与服务端时间戳；避免传播客户端 `localId`
- docs/API文档.md
  - 同步请求/响应示例补充 `localId`
- docs/技术实施指南.md
  - 同步示例代码更新为使用 `SyncRequest(changes, lastSyncAt)` 与 `SyncConfirmation(localId, remoteId, version)` 回填

## 说明
- 兼容性：新增字段均带默认值，且后端序列化启用 `ignoreUnknownKeys`，支持客户端逐步升级。
- 当前只落地 visit 的合并/推送（其他实体仍为 TODO），但协议层已对所有实体类型统一支持 `localId`。
